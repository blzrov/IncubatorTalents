import Head from "next/head";
import Link from "next/link";
import styles from "../styles/Home.module.scss";

import { sessionOptions } from "/lib/session";
import { withIronSessionSsr } from "iron-session/next";

import axios from "/utils/rest";
import Container from "react-bootstrap/Container";
import { SimpleGrid, Text, Space, Image, Card, Group, Button, useMantineTheme, Loader, Progress } from "@mantine/core";

export default function Home({ courses }) {
  const theme = useMantineTheme();

  return (
    <div className={styles.container}>
      <Head>
        <title>Инкубатор талантов</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Container>
        <Space h="xl" />
        <Text size="xl" weight={700} color="#036459" transform="uppercase">
          Мои курсы
        </Text>
        <Space h="lg" />
        <SimpleGrid cols={3}>
          {courses.map(({ course, tasks, tasks_ready }) => {
            return (
              <Link key={course.id} passHref href={`/courses/${course.id}`}>
                <Card
                  shadow="sm"
                  padding="lg"
                  radius="md"
                  withBorder
                  style={{ paddingBottom: "6px", cursor: "pointer" }}
                >
                  <Card.Section style={{ position: "relative" }}>
                    <Image src={"/" + course.image} height={125} alt="Инкубатор талантов" />
                  </Card.Section>
                  <Group position="apart">
                    <Text weight={500}>{course.name}</Text>
                  </Group>
                  {/* <Link passHref href={`/courses/${course.id}`}>
                  <Button color="green" fullWidth style={{ marginTop: 14 }}>
                    Начать обучение
                  </Button>
                </Link> */}
                  <div style={{ textAlign: "end", fontSize: "16px", color: "#1FBEAC" }}>
                    {Math.round((tasks_ready / tasks) * 100)}%
                  </div>
                  <Progress
                    style={{ marginTop: "auto" }}
                    color="#1FBEAC"
                    size="sm"
                    value={(tasks_ready / tasks) * 100}
                  />
                </Card>
              </Link>
            );
          })}
        </SimpleGrid>
      </Container>
    </div>
  );
}

export const getServerSideProps = withIronSessionSsr(async function getServerSideProps({ req }) {
  if (!req.cookies["user-cookies"]) {
    return {
      redirect: {
        destination: "/auth",
        permanent: false,
      },
    };
  }
  const response = await axios.get(`/public/courses`, {
    headers: {
      Cookie: `user-cookies=${req.cookies["user-cookies"]};`,
    },
  });
  let courses = [];
  if (response.status === 200) {
    courses = response.data;
  }
  return {
    props: {
      courses: courses,
      user: req.session.user,
    },
  };
}, sessionOptions);
